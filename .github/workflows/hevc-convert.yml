name: HEVC Alpha Converter

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: 'URL исходного видео'
        required: true
        type: string
      output_filename:
        description: 'Имя выходного файла'
        required: true
        type: string

jobs:
  convert:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
      - name: Download source video
        run: |
          curl -L --fail -o input.mov "${{ github.event.inputs.source_url }}"
          ls -lh input.mov

      - name: Convert to HEVC with Alpha
        run: |
          avconvert --source input.mov --output output.mov --preset PresetHEVCHighestQualityWithAlpha
          ls -lh output.mov

      - name: Upload to R2
        run: |
          curl -X PUT \
            -H "Authorization: AWS4-HMAC-SHA256" \
            -T output.mov \
            "${{ secrets.R2_ENDPOINT }}/hevc-video-converter/${{ github.event.inputs.output_filename }}" \
            --aws-sigv4 "aws:amz:auto:s3" \
            --user "${{ secrets.R2_ACCESS_KEY_ID }}:${{ secrets.R2_SECRET_ACCESS_KEY }}"

      - name: Cleanup
        if: always()
        run: rm -f input.mov output.mov
